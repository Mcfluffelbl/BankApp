@page "/MyAccounts"
@using BlazorApp1.Interface
@inject IAccountService AccountService

<h1>My Accounts</h1>

<ul>
    @* Display a sortable table if there are any accounts *@
    @if (_accounts.Any())
    {
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th @onclick="() => SortBy(nameof(BankAccount.Name))">
                        Name @GetSortIndicator(nameof(BankAccount.Name))
                    </th>
                    <th @onclick="() => SortBy(nameof(BankAccount.AccountType))">
                        Type @GetSortIndicator(nameof(BankAccount.AccountType))
                    </th>
                    <th @onclick="() => SortBy(nameof(BankAccount.Currency))">
                        Currency @GetSortIndicator(nameof(BankAccount.Currency))
                    </th>
                    <th @onclick="() => SortBy(nameof(BankAccount.Balance))">
                        Balance @GetSortIndicator(nameof(BankAccount.Balance))
                    </th>
                    <th @onclick="() => SortBy(nameof(BankAccount.LastUpdated))">
                        Last Updated @GetSortIndicator(nameof(BankAccount.LastUpdated))
                    </th>
                    <th>Delete Account</th>
                    @if (_accounts.Any(a => a.AccountType == AccountType.Savings))
                    {
                        <th>Interest Rate</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var account in _accounts)
                {
                    <tr>
                        <td>@account.Name</td>
                        <td>@account.AccountType</td>
                        <td>@account.Currency</td>
                        <td style="text-align:right">@($"{account.Balance:N2}")</td>
                        <td>@account.LastUpdated.ToString("g")</td>
                        <td><button class="btn btn-danger" @onclick="() => DeleteAccountAsync(account)">Delete</button></td>
                        @if (account.AccountType == AccountType.Savings)
                        {
                            <td>@($"{account.InterestRate:N2}%")</td>
                        }
                        else
                        {
                            <td></td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        @* Show a message if no accounts exist *@
        Console.WriteLine("You dont have any accounts yet");
        <h3>You dont have any accounts yet, go to "Add Account" And add youre first account.</h3>
    }
</ul>

@code {
    // Fields
    private List<BankAccount> _accounts = new();
    private string? _currentSortColumn;
    private bool _sortAscending = true;

    /// <summary>
    /// Initializes the component by loading accounts and applying interest to any savings accounts.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        _accounts = await AccountService.GetAccounts();

        foreach (var account in _accounts)
        {
            // If savings account, apply interest
            if (account.AccountType == AccountType.Savings)
            {
                var monthsSinceUpdate = ((DateTime.Now.Year - account.LastUpdated.Year) * 12)
                                      + DateTime.Now.Month - account.LastUpdated.Month;
                // Apply 3% interest for each month since the last update
                if (monthsSinceUpdate >= 1)
                {
                    await AccountService.ApplyInterest(account.Id); 
                }
            }
        }
        // Refresh accounts after interest has been applied
        _accounts = await AccountService.GetAccounts(); 
    }

    /// <summary>
    /// Sorts the account list based on the selected column.
    /// Clicking the same column toggles ascending/descending order.
    /// </summary>
    /// <param name="columnName"> Toggle ascending/descending </param>
    private void SortBy(string? columnName)
    {
        if (string.IsNullOrEmpty(columnName))
        {
            return;
        }
        if (_currentSortColumn == columnName)
        {
            _sortAscending = !_sortAscending;
        }
        else
        {
            _currentSortColumn = columnName;
            _sortAscending = true;
        }
        _accounts = columnName switch
        {
            nameof(BankAccount.Name) => _sortAscending
                ? _accounts.OrderBy(a => a.Name).ToList()
                : _accounts.OrderByDescending(a => a.Name).ToList(),

            nameof(BankAccount.AccountType) => _sortAscending
                ? _accounts.OrderBy(a => a.AccountType).ToList()
                : _accounts.OrderByDescending(a => a.AccountType).ToList(),

            nameof(BankAccount.Currency) => _sortAscending
                ? _accounts.OrderBy(a => a.Currency).ToList()
                : _accounts.OrderByDescending(a => a.Currency).ToList(),

            nameof(BankAccount.Balance) => _sortAscending
                ? _accounts.OrderBy(a => a.Balance).ToList()
                : _accounts.OrderByDescending(a => a.Balance).ToList(),

            nameof(BankAccount.LastUpdated) => _sortAscending
                ? _accounts.OrderBy(a => a.LastUpdated).ToList()
                : _accounts.OrderByDescending(a => a.LastUpdated).ToList(),

            _ => _accounts
        };
    }

    /// <summary>
    /// GetSortIndicator showing sort arrows depending on specified column.
    /// </summary>
    /// <param name="columnName">The column name to check.</param>
    /// <returns>The sort direction symbol if the column is currently sorted; otherwise, an empty string.</returns>
    private string GetSortIndicator(string columnName)
    {
        if (_currentSortColumn != columnName)
        {
            return string.Empty;
        }
        return _sortAscending ? "▲" : "▼";
    }

    /// <summary>
    /// Retrieves the latest list of accounts from the service.
    /// </summary>
    /// <returns></returns>
    private async Task GetAccountAsync()
    {
        try
        {
            _accounts = await AccountService.GetAccounts();
        }
        catch (Exception)
        {
            Console.WriteLine("You are missing input");
            throw;
        }
    }

    /// <summary>
    ///  Deletes the specified account and refreshes the account list.
    /// </summary>
    /// <param name="accountId">The account to delete.</param>
    /// <returns></returns>
    private async Task DeleteAccountAsync(BankAccount accountId)
    {
        try
        {
            await AccountService.DeleteAccount(accountId);
            await GetAccountAsync();
        }
        catch (Exception)
        {
            Console.WriteLine("Could not delete the account");
            throw;
        }
	}
}
